<!-- 
      Spectrum.html
      A custom element color picker with an API to get and set color of the
      color picker. 
-->

<!-- <script src="./externs.js"></script> -->
<script src="./utilities.js"></script>
<script type="text/javascript" src="common/WebInspector.js"></script>
<script type="text/javascript" src="common/Object.js"></script>
<script type="text/javascript" src="common/ParsedURL.js"></script>
<script type="text/javascript" src="common/Color.js"></script>
<script type="text/javascript" src="common/Geometry.js"></script>
<script type="text/javascript" src="common/DOMExtension.js"></script>
<script type="text/javascript" src="ui/SettingsUI.js"></script>
<script type="text/javascript" src="main/Main.js"></script>
<script type="text/javascript" src="ui/View.js"></script>
<script type="text/javascript" src="ui/UIUtils.js"></script>
<script type="text/javascript" src="InspectorFrontendHostStub.js"></script>
<script type="text/javascript" src="./Popover.js"></script>
<script type="text/javascript" src="components/InspectorView.js"></script>
<script type="text/javascript" src="ui/Dialog.js"></script>




<template id="spectrum-swatch-template">
  <style>
    @import url("spectrum.css")
  </style>
  <nobr>
    <span title="Mouseover txt..." class="swatch">
      <span class="swatch-inner" style="background-color: rgb(22, 26, 34);"></span>
    </span>
    <span>#161a22</span>
  </nobr>
</template>

<template id="spectrum-popover-template">
  <style>
    @import url("spectrum.css")
  </style>
</template>

<template id="color-picker-template">
<style>
    @import url("spectrum.css")
  </style>
</template>

<script>
  var importDoc = document.currentScript.ownerDocument;

  // The color picker
  var colorPickerPrototype = Object.create(HTMLElement.prototype, {
    createdCallback: {
      value: function() {
        var t = importDoc.querySelector('#color-picker-template');
        var clone = document.importNode(t.content, true);
        var root = this.createShadowRoot(); 

        root.appendChild(clone);
        root.appendChild(processColor("#CCCCCC"));

        console.log('Successfully stamped out color-picker!');
      }
    }
  });
  document.registerElement('color-picker', {prototype: colorPickerPrototype});

  // The swatch
  var spectrumSwatchPrototype = Object.create(HTMLElement.prototype, {
    createdCallback: {
      value: function() {
        var t = importDoc.querySelector('#spectrum-swatch-template');
        var clone = document.importNode(t.content, true);
        var root = this.createShadowRoot(); 
        root.appendChild(clone);

        console.log('Successfully stamped out spectrum-swatch!');
      }
    }
  });
  document.registerElement('spectrum-swatch', {prototype:
    spectrumSwatchPrototype});

  // The popover
  var spectrumPopoverPrototype = Object.create(HTMLElement.prototype, {
    createdCallback: {
      value: function() {
        var t = importDoc.querySelector('#spectrum-popover-template');
        var clone = document.importNode(t.content, true);
        var root = this.createShadowRoot(); 
        root.appendChild(clone);

        this.Spectrum = new Spectrum();
        root.appendChild(this.Spectrum.element);

        console.log('Successfully stamped out spectrum-popover!');
      }
    }
  });
  document.registerElement('spectrum-popover', {prototype: spectrumPopoverPrototype});
 
  Spectrum = function()
  {
      WebInspector.VBox.call(this);
      this.registerRequiredCSS("spectrum.css");
      
      this.element = document.createElement("div");
      this.element.classList.add("spectrum-container");
      this.element.tabIndex = 0;

      var topElement = this.element.createChild("div", "spectrum-top");
      topElement.createChild("div", "spectrum-fill");

      var topInnerElement = topElement.createChild("div", "spectrum-top-inner fill");
      this._draggerElement = topInnerElement.createChild("div", "spectrum-color");
      this._dragHelperElement = this._draggerElement.createChild("div", "spectrum-sat fill").createChild("div", "spectrum-val fill").createChild("div", "spectrum-dragger");

      this._sliderElement = topInnerElement.createChild("div", "spectrum-hue");
      this.slideHelper = this._sliderElement.createChild("div", "spectrum-slider");

      var rangeContainer = this.element.createChild("div", "spectrum-range-container");
      var alphaLabel = rangeContainer.createChild("label");
      alphaLabel.textContent = "\u03B1:";

      this._alphaElement = rangeContainer.createChild("input", "spectrum-range");
      this._alphaElement.setAttribute("type", "range");
      this._alphaElement.setAttribute("min", "0");
      this._alphaElement.setAttribute("max", "100");
      this._alphaElement.addEventListener("input", alphaDrag.bind(this), false);
      this._alphaElement.addEventListener("change", alphaDrag.bind(this), false);

      var swatchElement = document.createElement("span");
      swatchElement.className = "swatch";
      this._swatchInnerElement = swatchElement.createChild("span", "swatch-inner");

      var displayContainer = this.element.createChild("div");
      displayContainer.appendChild(swatchElement);
      this._displayElement = displayContainer.createChild("span", "source-code spectrum-display-value");

      Spectrum.draggable(this._sliderElement, hueDrag.bind(this));
      Spectrum.draggable(this._draggerElement, colorDrag.bind(this), colorDragStart.bind(this));

      console.log(this.element);

      /**
       * @param {!Element} element
       * @param {number} dragX
       * @param {number} dragY
       * @this {WebInspector.Spectrum}
       */
      function hueDrag(element, dragX, dragY)
      {
          this._hsv[0] = (this.slideHeight - dragY) / this.slideHeight;

          this._onchange();
      }

      var initialHelperOffset;

      /**
       * @this {WebInspector.Spectrum}
       */
      function colorDragStart()
      {
          initialHelperOffset = { x: this._dragHelperElement.offsetLeft, y: this._dragHelperElement.offsetTop };
      }

      /**
       * @param {!Element} element
       * @param {number} dragX
       * @param {number} dragY
       * @param {!MouseEvent} event
       * @this {WebInspector.Spectrum}
       */
      function colorDrag(element, dragX, dragY, event)
      {
          if (event.shiftKey) {
              if (Math.abs(dragX - initialHelperOffset.x) >= Math.abs(dragY - initialHelperOffset.y))
                  dragY = initialHelperOffset.y;
              else
                  dragX = initialHelperOffset.x;
          }

          this._hsv[1] = dragX / this.dragWidth;
          this._hsv[2] = (this.dragHeight - dragY) / this.dragHeight;

          this._onchange();
      }

      /**
       * @this {WebInspector.Spectrum}
       */
      function alphaDrag()
      {
          this._hsv[3] = this._alphaElement.value / 100;

          this._onchange();
      }
  };

  Spectrum.Events = {
      ColorChanged: "ColorChanged"
  };

  /**
   * @param {!Element} element
   * @param {function(!Element, number, number, !MouseEvent)=} onmove
   * @param {function(!Element, !MouseEvent)=} onstart
   * @param {function(!Element, !MouseEvent)=} onstop
   */
  Spectrum.draggable = function(element, onmove, onstart, onstop) {

      var doc = document;
      var dragging;
      var offset;
      var scrollOffset;
      var maxHeight;
      var maxWidth;

      /**
       * @param {?Event} e
       */
      function consume(e)
      {
          e.consume(true);
      }

      /**
       * @param {?Event} e
       */
      function move(e)
      {
          if (dragging) {
              var dragX = Math.max(0, Math.min(e.pageX - offset.left + scrollOffset.left, maxWidth));
              var dragY = Math.max(0, Math.min(e.pageY - offset.top + scrollOffset.top, maxHeight));

              if (onmove)
                  onmove(element, dragX, dragY, /** @type {!MouseEvent} */ (e));
          }
      }

      /**
       * @param {?Event} e
       */
      function start(e)
      {
          var mouseEvent = /** @type {!MouseEvent} */ (e);
          var rightClick = mouseEvent.which ? (mouseEvent.which === 3) : (mouseEvent.button === 2);

          if (!rightClick && !dragging) {

              if (onstart)
                  onstart(element, mouseEvent);

              dragging = true;
              maxHeight = element.clientHeight;
              maxWidth = element.clientWidth;

              scrollOffset = element.scrollOffset();
              offset = element.totalOffset();

              doc.addEventListener("selectstart", consume, false);
              doc.addEventListener("dragstart", consume, false);
              doc.addEventListener("mousemove", move, false);
              doc.addEventListener("mouseup", stop, false);

              move(mouseEvent);
              consume(mouseEvent);
          }
      }

      /**
       * @param {?Event} e
       */
      function stop(e)
      {
          if (dragging) {
              doc.removeEventListener("selectstart", consume, false);
              doc.removeEventListener("dragstart", consume, false);
              doc.removeEventListener("mousemove", move, false);
              doc.removeEventListener("mouseup", stop, false);

              if (onstop)
                  onstop(element, /** @type {!MouseEvent} */ (e));
          }

          dragging = false;
      }

      element.addEventListener("mousedown", start, false);
  };

  Spectrum.prototype = {
      /**
       * @param {!WebInspector.Color} color
       */
      setColor: function(color)
      {
          this._hsv = color.hsva();
      },

      /**
       * @return {!WebInspector.Color}
       */
      color: function()
      {
          return Color.fromHSVA(this._hsv);
      },

      _colorString: function()
      {
          var cf = WebInspector.Color.Format;
          var format = this._originalFormat;
          var color = this.color();
          var originalFormatString = color.toString(this._originalFormat);
          if (originalFormatString)
              return originalFormatString;

          if (color.hasAlpha()) {
              // Everything except HSL(A) should be returned as RGBA if transparency is involved.
              if (format === cf.HSLA || format === cf.HSL)
                  return color.toString(cf.HSLA);
              else
                  return color.toString(cf.RGBA);
          }

          if (format === cf.ShortHEX)
              return color.toString(cf.HEX);
          console.assert(format === cf.Nickname);
          return color.toString(cf.RGB);
      },


      set displayText(text)
      {
          this._displayElement.textContent = text;
      },

      _onchange: function()
      {
          this._updateUI();
          this.dispatchEventToListeners(Spectrum.Events.ColorChanged, this._colorString());
      },

      _updateHelperLocations: function()
      {
          var h = this._hsv[0];
          var s = this._hsv[1];
          var v = this._hsv[2];

          // Where to show the little circle that displays your current selected color.
          var dragX = s * this.dragWidth;
          var dragY = this.dragHeight - (v * this.dragHeight);

          dragX = Math.max(-this._dragHelperElementHeight,
                          Math.min(this.dragWidth - this._dragHelperElementHeight, dragX - this._dragHelperElementHeight));
          dragY = Math.max(-this._dragHelperElementHeight,
                          Math.min(this.dragHeight - this._dragHelperElementHeight, dragY - this._dragHelperElementHeight));

          this._dragHelperElement.positionAt(dragX, dragY);

          // Where to show the bar that displays your current selected hue.
          var slideY = this.slideHeight - ((h * this.slideHeight) + this.slideHelperHeight);
          this.slideHelper.style.top = slideY + "px";

          this._alphaElement.value = this._hsv[3] * 100;
      },

      _updateUI: function()
      {
          this._updateHelperLocations();

          this._draggerElement.style.backgroundColor = WebInspector.Color.fromHSVA([this._hsv[0], 1, 1, 1]).toString(WebInspector.Color.Format.RGB);
          this._swatchInnerElement.style.backgroundColor = this.color().toString(WebInspector.Color.Format.RGBA);

          this._alphaElement.value = this._hsv[3] * 100;
      },

      wasShown: function()
      {
          this.slideHeight = this._sliderElement.offsetHeight;
          this.dragWidth = this._draggerElement.offsetWidth;
          this.dragHeight = this._draggerElement.offsetHeight;
          this._dragHelperElementHeight = this._dragHelperElement.offsetHeight / 2;
          this.slideHelperHeight = this.slideHelper.offsetHeight / 2;
          this._updateUI();
      },

      __proto__: WebInspector.VBox.prototype

  }

  /**
   * @constructor
   * @extends {WebInspector.Object}
   */
  SpectrumPopupHelper = function()
  {
      this._spectrum = new Spectrum();
      this._spectrum.element.addEventListener("keydown", this._onKeyDown.bind(this), false);

      this._popover = new WebInspector.Popover();
      this._popover.setCanShrink(false);
      this._popover.element.addEventListener("mousedown", consumeEvent, false);

      this._hideProxy = this.hide.bind(this, true);
console.log("SpectrumPopupHelper instantiated.");
  }

  SpectrumPopupHelper.Events = {
      Hidden: "Hidden"
  };

  SpectrumPopupHelper.prototype = {
      /**
       * @return {!WebInspector.Spectrum}
       */
      spectrum: function()
      {
          return this._spectrum;
      },

      /**
       * @return {boolean}
       */
      toggle: function(element, color, format)
      {
          if (this._popover.isShowing())
              this.hide(true);
          else
              this.show(element, color, format);

          return this._popover.isShowing();
      },

      /**
       * @return {boolean}
       */
      show: function(element, color, format)
      {
console.log("SpectrumPopupHelper:show run.");
          if (this._popover.isShowing()) {
              if (this._anchorElement === element)
                  return false;

              // Reopen the picker for another anchor element.
              this.hide(true);
          }

          this._anchorElement = element;

          this._spectrum.setColor(color);
          this._spectrum._originalFormat = format !== WebInspector.Color.Format.Original ? format : color.format();
          this.reposition(element);

          document.addEventListener("mousedown", this._hideProxy, false);
          window.addEventListener("blur", this._hideProxy, false);
          return true;
      },

      reposition: function(element)
      {
       
          if (!this._previousFocusElement)
              this._previousFocusElement = WebInspector.currentFocusElement();
          this._popover.showView(this._spectrum, element);
          WebInspector.setCurrentFocusElement(this._spectrum.element);
          
      },

      /**
       * @param {boolean=} commitEdit
       */
      hide: function(commitEdit)
      {
          if (!this._popover.isShowing())
              return;
          this._popover.hide();

          document.removeEventListener("mousedown", this._hideProxy, false);
          window.removeEventListener("blur", this._hideProxy, false);

          this.dispatchEventToListeners(SpectrumPopupHelper.Events.Hidden, !!commitEdit);

          WebInspector.setCurrentFocusElement(this._previousFocusElement);
          delete this._previousFocusElement;

          delete this._anchorElement;
      },

      _onKeyDown: function(event)
      {
          if (event.keyIdentifier === "Enter") {
              this.hide(true);
              event.consume(true);
              return;
          }
          if (event.keyIdentifier === "U+001B") { // Escape key
              this.hide(false);
              event.consume(true);
          }
      },

      __proto__: WebInspector.Object.prototype
  }

  /**
   * @constructor
   * @param {boolean=} readOnly
   */
  ColorSwatch = function(readOnly)
  {
      this.element = document.createElement("span");
      this._swatchInnerElement = this.element.createChild("span", "swatch-inner");
//      var shiftClickMessage = WebInspector.UIString("Shift-click to change color format.");
//      this.element.title = readOnly ? shiftClickMessage : String.sprintf("%s\n%s", WebInspector.UIString("Click to open a colorpicker."), shiftClickMessage);
      this.element.className = "swatch";
      this.element.addEventListener("mousedown", consumeEvent, false);
      this.element.addEventListener("dblclick", consumeEvent, false);
  }

  ColorSwatch.prototype = {
      /**
       * @param {string} colorString
       */
      setColorString: function(colorString)
      {
          this._swatchInnerElement.style.backgroundColor = colorString;
      }
  }

  processColor = function(text)
  {
      /*
      var color = WebInspector.Color.parse(text);

      // We can be called with valid non-color values of |text| (like 'none' from border style)
      if (!color)
          return document.createTextNode(text);

      var format = WebInspector.StylesSidebarPane._colorFormat(color);
      var spectrumHelper = this.editablePane() && this.editablePane()._spectrumHelper;
      var spectrum = spectrumHelper ? spectrumHelper.spectrum() : null;

      var isEditable = !!(this._styleRule && this._styleRule.editable !== false); // |editable| is true by default.
      var colorSwatch = new WebInspector.ColorSwatch(!isEditable);
      colorSwatch.setColorString(text);
      colorSwatch.element.addEventListener("click", swatchClick.bind(this), false);

      var scrollerElement;
      var boundSpectrumChanged = spectrumChanged.bind(this);
      var boundSpectrumHidden = spectrumHidden.bind(this);
      */

      // Begin processColor port
      var color = Color.parse(text);
      var format = "original";
      var spectrumHelper = new SpectrumPopupHelper();
      var spectrum = spectrumHelper ? spectrumHelper.spectrum() : null;

      var isEditable = !!(this._styleRule && this._styleRule.editable !== false); // |editable| is true by default.
      var colorSwatch = new ColorSwatch();
      colorSwatch.setColorString(text)
      colorSwatch.element.addEventListener("click", swatchClick.bind(this), false);
      
      var scrollerElement;
      var boundSpectrumChanged = spectrumChanged.bind(this);
      var boundSpectrumHidden = spectrumHidden.bind(this);

      /**
       * @param {!WebInspector.Event} e
       * @this {WebInspector.StylePropertyTreeElementBase}
       */
      function spectrumChanged(e)
      {
          var colorString = /** @type {string} */ (e.data);
          spectrum.displayText = colorString;
          colorValueElement.textContent = colorString;
          colorSwatch.setColorString(colorString);
          // this.applyStyleText(nameElement.textContent + ": " + valueElement.textContent, false, false, false);
      }

      /**
       * @param {!WebInspector.Event} event
       * @this {WebInspector.StylePropertyTreeElementBase}
       */
      function spectrumHidden(event)
      {
          if (scrollerElement)
              scrollerElement.removeEventListener("scroll", repositionSpectrum, false);
          var commitEdit = event.data;
          var propertyText = !commitEdit && this.originalPropertyText ? this.originalPropertyText : (nameElement.textContent + ": " + valueElement.textContent);
          this.applyStyleText(propertyText, true, true, false);
          spectrum.removeEventListener(Spectrum.Events.ColorChanged, boundSpectrumChanged);
          spectrumHelper.removeEventListener(SpectrumPopupHelper.Events.Hidden, boundSpectrumHidden);

          delete this.editablePane()._isEditingStyle;
          delete this.originalPropertyText;
      }

      function repositionSpectrum()
      {
          spectrumHelper.reposition(colorSwatch.element);
      }

      /**
       * @param {?Event} e
       * @this {WebInspector.StylePropertyTreeElementBase}
       */
      function swatchClick(e)
      {
        console.log("click");
          e.consume(true);

          // Shift + click toggles color formats.
          // Click opens colorpicker, only if the element is not in computed styles section.
          if (!spectrumHelper || e.shiftKey) {
            console.log("failed");
              changeColorDisplay();
              return;
          }

          console.log(spectrumHelper);
          var visible = spectrumHelper.toggle(colorSwatch.element, color, format);
          if (visible) {
              spectrum.displayText = color.toString(format);
              //this.originalPropertyText = this.property.propertyText;
              //this.editablePane()._isEditingStyle = true;
              spectrum.addEventListener(Spectrum.Events.ColorChanged, boundSpectrumChanged);
              spectrumHelper.addEventListener(SpectrumPopupHelper.Events.Hidden, boundSpectrumHidden);

              scrollerElement = colorSwatch.element.enclosingNodeOrSelfWithClass("scroll-target");
              //console.log(colorSwatch.element);
              if (scrollerElement)
                  scrollerElement.addEventListener("scroll", repositionSpectrum, false);
              //else
              //    console.error("Unable to handle color picker scrolling");
          }
      }

      var colorValueElement = document.createElement("span");
      colorValueElement.textContent = "Fake string...";
      //colorValueElement.textContent = color.toString(format);

      /**
       * @param {string} curFormat
       */
      function nextFormat(curFormat)
      {
          // The format loop is as follows:
          // * original
          // * rgb(a)
          // * hsl(a)
          // * nickname (if the color has a nickname)
          // * if the color is simple:
          //   - shorthex (if has short hex)
          //   - hex
          var cf = Color.Format;

          switch (curFormat) {
              case cf.Original:
                  return !color.hasAlpha() ? cf.RGB : cf.RGBA;

              case cf.RGB:
              case cf.RGBA:
                  return !color.hasAlpha() ? cf.HSL : cf.HSLA;

              case cf.HSL:
              case cf.HSLA:
                  if (color.nickname())
                      return cf.Nickname;
                  if (!color.hasAlpha())
                      return color.canBeShortHex() ? cf.ShortHEX : cf.HEX;
                  else
                      return cf.Original;

              case cf.ShortHEX:
                  return cf.HEX;

              case cf.HEX:
                  return cf.Original;

              case cf.Nickname:
                  if (!color.hasAlpha())
                      return color.canBeShortHex() ? cf.ShortHEX : cf.HEX;
                  else
                      return cf.Original;

              default:
                  return cf.RGBA;
          }
      }

      function changeColorDisplay()
      {
          do {
              format = nextFormat(format);
              var currentValue = color.toString(format);
          } while (currentValue === colorValueElement.textContent);
          colorValueElement.textContent = currentValue;
      }

      var container = document.createElement("nobr");
      container.appendChild(colorSwatch.element);
      container.appendChild(colorValueElement);

console.log(container);

      return container;
  }

  // Color library
/**
 * @param {!Array.<number>} rgba
 * @param {string=} format
 * @param {string=} originalText
 * @constructor
 */
Color = function(rgba, format, originalText)
{
    this._rgba = rgba;
    this._originalText = originalText || null;
    this._format = format || null;
    if (typeof this._rgba[3] === "undefined")
        this._rgba[3] = 1;
    for (var i = 0; i < 4; ++i) {
        if (this._rgba[i] < 0)
            this._rgba[i] = 0;
        if (this._rgba[i] > 1)
            this._rgba[i] = 1;
    }
}

/**
 * @param {string} text
 * @return {?Color}
 */
Color.parse = function(text)
{
    // Simple - #hex, rgb(), nickname, hsl()
    var value = text.toLowerCase().replace(/\s+/g, "");
    var simple = /^(?:#([0-9a-f]{3,6})|rgb\(([^)]+)\)|(\w+)|hsl\(([^)]+)\))$/i;
    var match = value.match(simple);
    if (match) {
        if (match[1]) { // hex
            var hex = match[1].toUpperCase();
            var format;
            if (hex.length === 3) {
                format = Color.Format.ShortHEX;
                hex = hex.charAt(0) + hex.charAt(0) + hex.charAt(1) + hex.charAt(1) + hex.charAt(2) + hex.charAt(2);
            } else
                format = Color.Format.HEX;
            var r = parseInt(hex.substring(0,2), 16);
            var g = parseInt(hex.substring(2,4), 16);
            var b = parseInt(hex.substring(4,6), 16);
            return new Color([r / 255, g / 255, b / 255, 1], format, text);
        }

        if (match[2]) { // rgb
            var rgbString = match[2].split(/\s*,\s*/);
            var rgba = [ Color._parseRgbNumeric(rgbString[0]),
                         Color._parseRgbNumeric(rgbString[1]),
                         Color._parseRgbNumeric(rgbString[2]), 1 ];
            return new Color(rgba, Color.Format.RGB, text);
        }

        if (match[3]) { // nickname
            var nickname = match[3].toLowerCase();
            if (nickname in Color.Nicknames) {
                var rgba = Color.Nicknames[nickname];
                var color = Color.fromRGBA(rgba);
                color._format = Color.Format.Nickname;
                color._originalText = nickname;
                return color;
            }
            return null;
        }

        if (match[4]) { // hsl
            var hslString = match[4].replace(/%/g, "").split(/\s*,\s*/);
            var hsla = [ Color._parseHueNumeric(hslString[0]),
                         Color._parseSatLightNumeric(hslString[1]),
                         Color._parseSatLightNumeric(hslString[2]), 1 ];
            var rgba = Color._hsl2rgb(hsla);
            return new Color(rgba, Color.Format.HSL, text);
        }

        return null;
    }

    // Advanced - rgba(), hsla()
    var advanced = /^(?:rgba\(([^)]+)\)|hsla\(([^)]+)\))$/;
    match = value.match(advanced);
    if (match) {
        if (match[1]) { // rgba
            var rgbaString = match[1].split(/\s*,\s*/);
            var rgba = [ Color._parseRgbNumeric(rgbaString[0]),
                         Color._parseRgbNumeric(rgbaString[1]),
                         Color._parseRgbNumeric(rgbaString[2]),
                         Color._parseAlphaNumeric(rgbaString[3]) ];
            return new Color(rgba, Color.Format.RGBA, text);
        }

        if (match[2]) { // hsla
            var hslaString = match[2].replace(/%/g, "").split(/\s*,\s*/);
            var hsla = [ Color._parseHueNumeric(hslaString[0]),
                         Color._parseSatLightNumeric(hslaString[1]),
                         Color._parseSatLightNumeric(hslaString[2]),
                         Color._parseAlphaNumeric(hslaString[3]) ];
            var rgba = Color._hsl2rgb(hsla);
            return new Color(rgba, Color.Format.HSLA, text);
        }
    }

    return null;
}

/**
 * @param {!Array.<number>} rgba
 * @return {!Color}
 */
Color.fromRGBA = function(rgba)
{
    return new Color([rgba[0] / 255, rgba[1] / 255, rgba[2] / 255, rgba[3]]);
}

/**
 * @param {!Array.<number>} hsva
 * @return {!Color}
 */
Color.fromHSVA = function(hsva)
{
    var h = hsva[0];
    var s = hsva[1];
    var v = hsva[2];

    var t = (2 - s) * v;
    if (v === 0 || s === 0)
        s = 0;
    else
        s *= v / (t < 1 ? t : 2 - t);
    var hsla = [h, s, t / 2, hsva[3]];

    return new Color(Color._hsl2rgb(hsla), Color.Format.HSLA);
}

Color.prototype = {
    /**
     * @return {?string}
     */
    format: function()
    {
        return this._format;
    },

    /**
     * @return {!Array.<number>} HSLA with components within [0..1]
     */
    hsla: function()
    {
        if (this._hsla)
            return this._hsla;
        var r = this._rgba[0];
        var g = this._rgba[1];
        var b = this._rgba[2];
        var max = Math.max(r, g, b);
        var min = Math.min(r, g, b);
        var diff = max - min;
        var add = max + min;

        if (min === max)
            var h = 0;
        else if (r === max)
            var h = ((1/6 * (g - b) / diff) + 1) % 1;
        else if (g === max)
            var h = (1/6 * (b - r) / diff) + 1/3;
        else
            var h = (1/6 * (r - g) / diff) + 2/3;

        var l = 0.5 * add;

        if (l === 0)
            var s = 0;
        else if (l === 1)
            var s = 1;
        else if (l <= 0.5)
            var s = diff / add;
        else
            var s = diff / (2 - add);

        this._hsla = [h, s, l, this._rgba[3]];
        return this._hsla;
    },

    /**
     * @return {!Array.<number>} HSVA with components within [0..1]
     */
    hsva: function()
    {
        var hsla = this.hsla();
        var h = hsla[0];
        var s = hsla[1];
        var l = hsla[2];

        s *= l < 0.5 ? l : 1 - l;
        return [h, s !== 0 ? 2 * s / (l + s) : 0, (l + s), hsla[3]];
    },

    /**
     * @return {boolean}
     */
    hasAlpha: function()
    {
        return this._rgba[3] !== 1;
    },

    /**
     * @return {boolean}
     */
    canBeShortHex: function()
    {
        if (this.hasAlpha())
            return false;
        for (var i = 0; i < 3; ++i) {
            var c = Math.round(this._rgba[i] * 255);
            if (c % 17)
                return false;
        }
        return true;
    },

    /**
     * @return {?string}
     */
    toString: function(format)
    {
        if (!format)
            format = this._format;

        /**
         * @param {number} value
         * @return {number}
         */
        function toRgbValue(value)
        {
            return Math.round(value * 255);
        }

        /**
         * @param {number} value
         * @return {string}
         */
        function toHexValue(value)
        {
            var hex = Math.round(value * 255).toString(16);
            return hex.length === 1 ? "0" + hex : hex;
        }

        /**
         * @param {number} value
         * @return {string}
         */
        function toShortHexValue(value)
        {
            return (Math.round(value * 255) / 17).toString(16);
        }

        switch (format) {
        case Color.Format.Original:
            return this._originalText;
        case Color.Format.RGB:
            if (this.hasAlpha())
                return null;
            return String.sprintf("rgb(%d, %d, %d)", toRgbValue(this._rgba[0]), toRgbValue(this._rgba[1]), toRgbValue(this._rgba[2]));
        case Color.Format.RGBA:
            return String.sprintf("rgba(%d, %d, %d, %f)", toRgbValue(this._rgba[0]), toRgbValue(this._rgba[1]), toRgbValue(this._rgba[2]), this._rgba[3]);
        case Color.Format.HSL:
            if (this.hasAlpha())
                return null;
            var hsl = this.hsla();
            return String.sprintf("hsl(%d, %d%, %d%)", Math.round(hsl[0] * 360), Math.round(hsl[1] * 100), Math.round(hsl[2] * 100));
        case Color.Format.HSLA:
            var hsla = this.hsla();
            return String.sprintf("hsla(%d, %d%, %d%, %f)", Math.round(hsla[0] * 360), Math.round(hsla[1] * 100), Math.round(hsla[2] * 100), hsla[3]);
        case Color.Format.HEX:
            if (this.hasAlpha())
                return null;
            return String.sprintf("#%s%s%s", toHexValue(this._rgba[0]), toHexValue(this._rgba[1]), toHexValue(this._rgba[2])).toUpperCase();
        case Color.Format.ShortHEX:
            if (!this.canBeShortHex())
                return null;
            return String.sprintf("#%s%s%s", toShortHexValue(this._rgba[0]), toShortHexValue(this._rgba[1]), toShortHexValue(this._rgba[2])).toUpperCase();
        case Color.Format.Nickname:
            return this.nickname();
        }

        return this._originalText;
    },

    /**
     * @return {!Array.<number>}
     */
    _canonicalRGBA: function()
    {
        var rgba = new Array(3);
        for (var i = 0; i < 3; ++i)
            rgba[i] = Math.round(this._rgba[i] * 255);
        if (this._rgba[3] !== 1)
            rgba.push(this._rgba[3]);
        return rgba;
    },

    /**
     * @return {?string} nickname
     */
    nickname: function()
    {
        if (!Color._rgbaToNickname) {
            Color._rgbaToNickname = {};
            for (var nickname in Color.Nicknames) {
                var rgba = Color.Nicknames[nickname];
                Color._rgbaToNickname[rgba] = nickname;
            }
        }

        return Color._rgbaToNickname[this._canonicalRGBA()] || null;
    },

    /**
     * @return {!DOMAgent.RGBA}
     */
    toProtocolRGBA: function()
    {
        var rgba = this._canonicalRGBA();
        var result = { r: rgba[0], g: rgba[1], b: rgba[2] };
        if (rgba[3] !== 1)
            result.a = rgba[3];
        return result;
    },

    /**
     * @return {!Color}
     */
    invert: function()
    {
        var rgba = [];
        rgba[0] = 1 - this._rgba[0];
        rgba[1] = 1 - this._rgba[1];
        rgba[2] = 1 - this._rgba[2];
        rgba[3] = this._rgba[3];
        return new Color(rgba);
    },

    /**
     * @param {number} alpha
     * @return {!Color}
     */
     setAlpha: function(alpha)
     {
         var rgba = this._rgba.slice();
         rgba[3] = alpha;
         return new Color(rgba);
     }
}

/**
 * @param {string} value
 * return {number}
 */
Color._parseRgbNumeric = function(value)
{
    var parsed = parseInt(value, 10);
    if (value.indexOf("%") !== -1)
        parsed /= 100;
    else
        parsed /= 255;
    return parsed;
}

/**
 * @param {string} value
 * return {number}
 */
Color._parseHueNumeric = function(value)
{
    return isNaN(value) ? 0 : (parseFloat(value) / 360) % 1;
}

/**
 * @param {string} value
 * return {number}
 */
Color._parseSatLightNumeric = function(value)
{
    return parseFloat(value) / 100;
}

/**
 * @param {string} value
 * return {number}
 */
Color._parseAlphaNumeric = function(value)
{
    return isNaN(value) ? 0 : parseFloat(value);
}

/**
 * @param {!Array.<number>} hsl
 * @return {!Array.<number>}
 */
Color._hsl2rgb = function(hsl)
{
    var h = hsl[0];
    var s = hsl[1];
    var l = hsl[2];

    function hue2rgb(p, q, h)
    {
        if (h < 0)
            h += 1;
        else if (h > 1)
            h -= 1;

        if ((h * 6) < 1)
            return p + (q - p) * h * 6;
        else if ((h * 2) < 1)
            return q;
        else if ((h * 3) < 2)
            return p + (q - p) * ((2 / 3) - h) * 6;
        else
            return p;
    }

    if (s < 0)
        s = 0;

    if (l <= 0.5)
        var q = l * (1 + s);
    else
        var q = l + s - (l * s);

    var p = 2 * l - q;

    var tr = h + (1 / 3);
    var tg = h;
    var tb = h - (1 / 3);

    var r = hue2rgb(p, q, tr);
    var g = hue2rgb(p, q, tg);
    var b = hue2rgb(p, q, tb);
    return [r, g, b, hsl[3]];
}

Color.Nicknames = {
    "aliceblue":          [240,248,255],
    "antiquewhite":       [250,235,215],
    "aquamarine":         [127,255,212],
    "azure":              [240,255,255],
    "beige":              [245,245,220],
    "bisque":             [255,228,196],
    "black":              [0,0,0],
    "blanchedalmond":     [255,235,205],
    "blue":               [0,0,255],
    "blueviolet":         [138,43,226],
    "brown":              [165,42,42],
    "burlywood":          [222,184,135],
    "cadetblue":          [95,158,160],
    "chartreuse":         [127,255,0],
    "chocolate":          [210,105,30],
    "coral":              [255,127,80],
    "cornflowerblue":     [100,149,237],
    "cornsilk":           [255,248,220],
    "crimson":            [237,20,61],
    "cyan":               [0,255,255],
    "darkblue":           [0,0,139],
    "darkcyan":           [0,139,139],
    "darkgoldenrod":      [184,134,11],
    "darkgray":           [169,169,169],
    "darkgrey":           [169,169,169],
    "darkgreen":          [0,100,0],
    "darkkhaki":          [189,183,107],
    "darkmagenta":        [139,0,139],
    "darkolivegreen":     [85,107,47],
    "darkorange":         [255,140,0],
    "darkorchid":         [153,50,204],
    "darkred":            [139,0,0],
    "darksalmon":         [233,150,122],
    "darkseagreen":       [143,188,143],
    "darkslateblue":      [72,61,139],
    "darkslategray":      [47,79,79],
    "darkslategrey":      [47,79,79],
    "darkturquoise":      [0,206,209],
    "darkviolet":         [148,0,211],
    "deeppink":           [255,20,147],
    "deepskyblue":        [0,191,255],
    "dimgray":            [105,105,105],
    "dimgrey":            [105,105,105],
    "dodgerblue":         [30,144,255],
    "firebrick":          [178,34,34],
    "floralwhite":        [255,250,240],
    "forestgreen":        [34,139,34],
    "gainsboro":          [220,220,220],
    "ghostwhite":         [248,248,255],
    "gold":               [255,215,0],
    "goldenrod":          [218,165,32],
    "gray":               [128,128,128],
    "grey":               [128,128,128],
    "green":              [0,128,0],
    "greenyellow":        [173,255,47],
    "honeydew":           [240,255,240],
    "hotpink":            [255,105,180],
    "indianred":          [205,92,92],
    "indigo":             [75,0,130],
    "ivory":              [255,255,240],
    "khaki":              [240,230,140],
    "lavender":           [230,230,250],
    "lavenderblush":      [255,240,245],
    "lawngreen":          [124,252,0],
    "lemonchiffon":       [255,250,205],
    "lightblue":          [173,216,230],
    "lightcoral":         [240,128,128],
    "lightcyan":          [224,255,255],
    "lightgoldenrodyellow":[250,250,210],
    "lightgreen":         [144,238,144],
    "lightgray":          [211,211,211],
    "lightgrey":          [211,211,211],
    "lightpink":          [255,182,193],
    "lightsalmon":        [255,160,122],
    "lightseagreen":      [32,178,170],
    "lightskyblue":       [135,206,250],
    "lightslategray":     [119,136,153],
    "lightslategrey":     [119,136,153],
    "lightsteelblue":     [176,196,222],
    "lightyellow":        [255,255,224],
    "lime":               [0,255,0],
    "limegreen":          [50,205,50],
    "linen":              [250,240,230],
    "magenta":            [255,0,255],
    "maroon":             [128,0,0],
    "mediumaquamarine":   [102,205,170],
    "mediumblue":         [0,0,205],
    "mediumorchid":       [186,85,211],
    "mediumpurple":       [147,112,219],
    "mediumseagreen":     [60,179,113],
    "mediumslateblue":    [123,104,238],
    "mediumspringgreen":  [0,250,154],
    "mediumturquoise":    [72,209,204],
    "mediumvioletred":    [199,21,133],
    "midnightblue":       [25,25,112],
    "mintcream":          [245,255,250],
    "mistyrose":          [255,228,225],
    "moccasin":           [255,228,181],
    "navajowhite":        [255,222,173],
    "navy":               [0,0,128],
    "oldlace":            [253,245,230],
    "olive":              [128,128,0],
    "olivedrab":          [107,142,35],
    "orange":             [255,165,0],
    "orangered":          [255,69,0],
    "orchid":             [218,112,214],
    "palegoldenrod":      [238,232,170],
    "palegreen":          [152,251,152],
    "paleturquoise":      [175,238,238],
    "palevioletred":      [219,112,147],
    "papayawhip":         [255,239,213],
    "peachpuff":          [255,218,185],
    "peru":               [205,133,63],
    "pink":               [255,192,203],
    "plum":               [221,160,221],
    "powderblue":         [176,224,230],
    "purple":             [128,0,128],
    "red":                [255,0,0],
    "rosybrown":          [188,143,143],
    "royalblue":          [65,105,225],
    "saddlebrown":        [139,69,19],
    "salmon":             [250,128,114],
    "sandybrown":         [244,164,96],
    "seagreen":           [46,139,87],
    "seashell":           [255,245,238],
    "sienna":             [160,82,45],
    "silver":             [192,192,192],
    "skyblue":            [135,206,235],
    "slateblue":          [106,90,205],
    "slategray":          [112,128,144],
    "slategrey":          [112,128,144],
    "snow":               [255,250,250],
    "springgreen":        [0,255,127],
    "steelblue":          [70,130,180],
    "tan":                [210,180,140],
    "teal":               [0,128,128],
    "thistle":            [216,191,216],
    "tomato":             [255,99,71],
    "turquoise":          [64,224,208],
    "violet":             [238,130,238],
    "wheat":              [245,222,179],
    "white":              [255,255,255],
    "whitesmoke":         [245,245,245],
    "yellow":             [255,255,0],
    "yellowgreen":        [154,205,50],
    "transparent":        [0, 0, 0, 0],
};

Color.PageHighlight = {
    Content: Color.fromRGBA([111, 168, 220, .66]),
    ContentLight: Color.fromRGBA([111, 168, 220, .5]),
    ContentOutline: Color.fromRGBA([9, 83, 148]),
    Padding: Color.fromRGBA([147, 196, 125, .55]),
    PaddingLight: Color.fromRGBA([147, 196, 125, .4]),
    Border: Color.fromRGBA([255, 229, 153, .66]),
    BorderLight: Color.fromRGBA([255, 229, 153, .5]),
    Margin: Color.fromRGBA([246, 178, 107, .66]),
    MarginLight: Color.fromRGBA([246, 178, 107, .5]),
    EventTarget: Color.fromRGBA([255, 196, 196, .66])
}

Color.Format = {
    Original: "original",
    Nickname: "nickname",
    HEX: "hex",
    ShortHEX: "shorthex",
    RGB: "rgb",
    RGBA: "rgba",
    HSL: "hsl",
    HSLA: "hsla"
}

  console.log(WebInspector);
 
</script>
